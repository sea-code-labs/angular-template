image: alpine/git:latest

pipelines:
  default:
    - step:
        name: Validate Branch and Commits
        script:
          - echo "Validating branch name and commit count..."
          - current_branch=$(git rev-parse --abbrev-ref HEAD)
          - target_branch=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-$current_branch}

          - if [[ -z "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" || "$target_branch" == "main" || "$target_branch" == "develop" ]]; then
            echo "Not validating branch name because it's a PR to 'main' or 'develop' or not a PR.";
            else
            if [[ ! "$current_branch" =~ ^feature-.* ]]; then
            echo "Branch name must start with 'feature-'.";
            exit 1;
            fi
            fi

    - step:
        name: Check PR Source for Main
        script:
          - echo "Checking if the pull request is from 'develop' branch..."
          - |
            if [ "$BITBUCKET_PR_DESTINATION" == "main" ]; then
              git fetch --all
              source_branch=$BITBUCKET_PR_SOURCE
              if [ "$source_branch" != "develop" ]; then
                echo "Error: Pull request to 'main' must come from 'develop' branch.";
                exit 1;
              fi
            else
              echo "Not a pull request to 'main', skipping branch check.";
            fi

    - step:
        name: Clean Up Branches
        script:
          - echo "Fetching all branches..."
          - git fetch --all
          - echo "Cleaning up merged branches..."
          - git branch -r --merged origin/develop | grep -v '\->' | grep -v 'develop$' | while read -r branch; do
            git push origin --delete "${branch#origin/}";
            done

    - step:
        name: Sync GitHub Mirror
        clone:
          enabled: false
        script:
          - echo "Cloning Bitbucket repository..."
          - git clone --bare git@bitbucket.org:sea-code-labs/angular-template.git
          - cd angular-template.git
          - echo "Pushing to GitHub mirror..."
          - git push --mirror git@github.com:sea-code-labs/angular-template.git
